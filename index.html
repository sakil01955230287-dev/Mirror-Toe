<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror's Tic-Tac-Toe | Royal Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-gold: #D4AF37;
            --secondary-gold: #FCF6BA;
            --dark-bg: #0B1026;
            --card-bg: rgba(11, 16, 38, 0.7);
            --glass-effect: rgba(212, 175, 55, 0.1);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .royal-title {
            font-family: 'Cinzel', serif;
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 5s linear infinite;
        }
        
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        .silver-gradient {
            background: linear-gradient(to right, #A0A0A0, #F0F0F0, #D0D0D0, #FFFFFF, #B0B0B0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 6s linear infinite;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.08);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-royal {
            background: linear-gradient(135deg, #8B7355, #D4AF37, #FCF6BA);
            color: #0B1026;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-weight: 600;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .btn-royal:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-royal::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-royal:hover::after {
            left: 100%;
        }
        
        .btn-noble {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            transition: all 0.3s ease;
            color: #FCF6BA;
        }
        
        .btn-noble:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        .game-cell {
            aspect-ratio: 1;
            background: rgba(30, 41, 59, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .game-cell:hover:not(.occupied) {
            background: rgba(51, 65, 85, 0.4);
            border-color: rgba(212, 175, 55, 0.4);
            transform: scale(1.02);
        }
        
        /* Updated X and O styles to match the title effects */
        .game-cell.x-mark .cell-content {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 5s linear infinite;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.4));
        }
        
        .game-cell.o-mark .cell-content {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            background: linear-gradient(to right, #A0A0A0, #F0F0F0, #D0D0D0, #FFFFFF, #B0B0B0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 6s linear infinite;
            text-shadow: 0 0 15px rgba(192, 192, 192, 0.5);
            filter: drop-shadow(0 0 8px rgba(192, 192, 192, 0.4));
        }
        
        .winning-cell {
            animation: pulse-win 2s infinite;
            background: linear-gradient(45deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1)) !important;
        }
        
        @keyframes pulse-win {
            0%, 100% { box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }
        }
        
        .cell-content {
            font-family: 'Cinzel', serif;
            font-weight: 700;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .gradient-border {
            position: relative;
            border: double 2px transparent;
            background-image: linear-gradient(var(--card-bg), var(--card-bg)), 
                              linear-gradient(135deg, #8B7355, #D4AF37);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }
        
        .floating-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 115, 85, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(192, 192, 192, 0.03) 0%, transparent 50%);
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .online { background-color: #10b981; }
        .offline { background-color: #ef4444; }
        .waiting { background-color: #D4AF37; }
        
        .player-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .player-card:hover {
            transform: translateX(4px);
            border-left-color: var(--primary-gold);
        }
        
        .winner-glow {
            animation: winnerGlow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes winnerGlow {
            from { filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.5)); }
            to { filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.8)); }
        }
        
        .game-id-badge {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .reflection {
            mask-image: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0));
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0));
            transform: scaleY(-1) translateY(-10px);
            opacity: 0.2;
            filter: blur(2px);
            pointer-events: none;
        }
        
        .float-animation {
            animation: float 4s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .create-account-text {
            background: linear-gradient(to right, #A0A0A0, #F0F0F0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: all 0.3s ease;
        }
        
        .create-account-text:hover {
            background: linear-gradient(to right, #D4AF37, #FCF6BA);
            -webkit-background-clip: text;
            background-clip: text;
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Floating Background Elements -->
    <div class="floating-bg"></div>
    
    <!-- Audio Elements -->
    <audio id="bg-music" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>
    <audio id="tap-sound">
        <source src="tap.mp3" type="audio/mpeg">
    </audio>
    <audio id="win-sound">
        <source src="win.mp3" type="audio/mpeg">
    </audio>
    <audio id="draw-sound">
        <source src="draw.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Main Container -->
    <div class="min-h-screen flex items-center justify-center p-4">
        <div id="app-container" class="w-full max-w-md mx-auto">
            <!-- Welcome Screen -->
            <div id="welcome-view" class="glass-panel rounded-2xl p-8 slide-in">
                <div class="text-center mb-8">
                    <h1 class="royal-title text-4xl font-bold mb-2">Mr. MirrorToe</h1>
                    <p class="silver-gradient text-sm tracking-[0.3em] uppercase">Royal Edition</p>
                </div>
                
                <div id="welcome-content" class="space-y-6">
                    <div class="text-center">
                        <p class="text-gray-300 mb-6">Enter the royal arena of strategic mastery. Play locally, challenge the royal AI, or battle nobility online in real-time.</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button id="quick-play-btn" 
                                class="btn-royal w-full py-4 rounded-xl font-semibold flex items-center justify-center space-x-3">
                            <span>‚ö°</span>
                            <span>Quick Play (Guest)</span>
                        </button>
                        
                        <button id="royal-login-btn" 
                                class="btn-noble w-full py-4 rounded-xl font-semibold flex items-center justify-center space-x-3">
                            <span>üëë</span>
                            <span>Royal Login</span>
                        </button>
                        
                        <div class="text-center pt-2">
                            <button id="create-account-text" 
                                    class="create-account-text text-sm">
                                Create Account
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center text-gray-500 text-sm pt-4 border-t border-gray-800">
                        <p>No registration needed for guest play. Create an account to join the nobility!</p>
                    </div>
                </div>
                
                <!-- Account Creation Form (Initially Hidden) -->
                <div id="account-form" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Royal Name</label>
                        <input type="text" id="display-name" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Enter your royal name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                        <input type="text" id="username" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Choose a unique username">
                        <p class="text-xs text-gray-500 mt-1">This will be your royal identity</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Passcode</label>
                        <input type="password" id="passcode" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Create a secure passcode">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Confirm Passcode</label>
                        <input type="password" id="confirm-passcode" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Re-enter your passcode">
                    </div>
                    
                    <div class="space-y-4">
                        <button id="register-btn" 
                                class="btn-royal w-full py-3 rounded-xl font-semibold flex items-center justify-center">
                            <span id="auth-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 mr-2"></span>
                            Join the Royal Court
                        </button>
                        
                        <button id="back-to-welcome" 
                                class="btn-noble w-full py-3 rounded-xl font-semibold">
                            ‚Üê Return to Welcome
                        </button>
                    </div>
                    
                    <div id="auth-error" class="hidden p-3 bg-red-900/20 border border-red-700/30 rounded-xl text-red-300 text-sm"></div>
                </div>
                
                <!-- Login Form (Initially Hidden) -->
                <div id="login-form" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                        <input type="text" id="login-username" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Enter your username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Passcode</label>
                        <input type="password" id="login-passcode" 
                               class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                               placeholder="Enter your passcode">
                    </div>
                    
                    <div class="space-y-4">
                        <button id="login-btn" 
                                class="btn-royal w-full py-3 rounded-xl font-semibold flex items-center justify-center">
                            <span id="login-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 mr-2"></span>
                            Enter Royal Court
                        </button>
                        
                        <button id="back-to-welcome-from-login" 
                                class="btn-noble w-full py-3 rounded-xl font-semibold">
                            ‚Üê Return to Welcome
                        </button>
                    </div>
                    
                    <div id="login-error" class="hidden p-3 bg-red-900/20 border border-red-700/30 rounded-xl text-red-300 text-sm"></div>
                </div>
            </div>
            
            <!-- Game View (Initially Hidden) -->
            <div id="game-view" class="hidden">
                <!-- Header -->
                <div class="glass-panel rounded-2xl p-6 mb-6 slide-in">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="royal-title text-2xl font-bold">Mr. MirrorToe</h1>
                            <div id="user-info" class="text-sm text-gray-400 mt-1 flex items-center">
                                <span id="current-username" class="text-yellow-300 font-medium mr-2"></span>
                                <span id="online-status" class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full flex items-center">
                                    <span class="status-dot online mr-1"></span>
                                    <span>Online</span>
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="profile-btn" class="btn-noble px-3 py-2 rounded-xl text-sm">
                                üëë Profile
                            </button>
                            <button id="logout-btn" class="btn-noble px-3 py-2 rounded-xl text-sm">
                                Exit Court
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scoreboard -->
                    <div id="scoreboard" class="gradient-border rounded-xl p-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="royal-title text-2xl font-bold" id="score-x">0</div>
                                <div class="text-xs text-gray-400">Royal X</div>
                            </div>
                            <div>
                                <div class="silver-gradient text-2xl font-bold" id="score-draws">0</div>
                                <div class="text-xs text-gray-400">Stalemates</div>
                            </div>
                            <div>
                                <div class="silver-gradient text-2xl font-bold" id="score-o">0</div>
                                <div class="text-xs text-gray-400">Noble O</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Mode Selection -->
                <div id="mode-selection" class="glass-panel rounded-2xl p-6 mb-6 slide-in">
                    <h2 class="text-xl font-semibold text-white mb-4 text-center">Select Your Challenge</h2>
                    <div class="space-y-4">
                        <button onclick="setGameMode('local')" 
                                class="btn-royal w-full py-4 rounded-xl font-semibold flex items-center justify-center space-x-3">
                            <span>‚öîÔ∏è</span>
                            <span>Royal Duel (2 Players)</span>
                        </button>
                        
                        <button onclick="setGameMode('ai')" 
                                class="btn-royal w-full py-4 rounded-xl font-semibold flex items-center justify-center space-x-3">
                            <span>ü§ñ</span>
                            <span>Challenge Mr. Mirror</span>
                        </button>
                        
                        <button onclick="showOnlineMode()" 
                                class="btn-royal w-full py-4 rounded-xl font-semibold flex items-center justify-center space-x-3">
                            <span>üåê</span>
                            <span>Royal Battle Online</span>
                        </button>
                    </div>
                </div>
                
                <!-- Online Controls -->
                <div id="online-controls" class="glass-panel rounded-2xl p-6 mb-6 hidden slide-in">
                    <h2 class="text-xl font-semibold text-white mb-4 text-center">Royal Battle Online</h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="text-center">
                            <div class="text-sm text-gray-400 mb-1">Your Royal Seal</div>
                            <div id="game-id-display" class="game-id-badge text-lg text-yellow-300 p-3 rounded-xl break-all"></div>
                            <button onclick="copyGameId()" class="text-xs text-gray-400 hover:text-yellow-300 mt-2 transition">
                                üìã Copy to share
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Join Existing Battle</label>
                            <input type="text" id="join-game-input" 
                                   class="w-full px-4 py-3 bg-gray-900/30 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                                   placeholder="Enter opponent's Royal Seal">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="createOnlineGame()" 
                                class="btn-royal py-3 rounded-xl font-semibold">
                            Create Battle
                        </button>
                        
                        <button onclick="joinOnlineGame()" 
                                class="btn-noble py-3 rounded-xl font-semibold">
                            Join Battle
                        </button>
                    </div>
                    
                    <button onclick="backToModes()" 
                            class="w-full mt-4 py-2 text-gray-400 hover:text-yellow-300 text-sm transition">
                        ‚Üê Return to challenges
                    </button>
                </div>
                
                <!-- Game Board -->
                <div id="game-board-container" class="glass-panel rounded-2xl p-6 hidden slide-in">
                    <div id="game-status" class="text-center mb-6 p-4 bg-gray-900/30 rounded-xl">
                        <div id="status-message" class="text-xl font-semibold"></div>
                        <div id="turn-indicator" class="text-sm text-gray-400 mt-2 flex items-center justify-center">
                            <span class="status-dot waiting mr-2"></span>
                            <span>Preparing the arena...</span>
                        </div>
                    </div>
                    
                    <!-- Game Board Grid -->
                    <div id="board-grid" class="grid grid-cols-3 gap-3 mb-6">
                        <!-- Cells will be generated by JavaScript -->
                    </div>
                    
                    <!-- Game Controls -->
                    <div class="space-y-4">
                        <div id="local-controls" class="grid grid-cols-2 gap-4">
                            <button id="restart-game" 
                                    class="btn-noble py-3 rounded-xl font-semibold">
                                Reset Arena
                            </button>
                            
                            <button id="change-mode" 
                                    class="btn-royal py-3 rounded-xl font-semibold">
                                Change Challenge
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <button id="audio-toggle" 
                                    class="px-4 py-2 bg-yellow-600/30 rounded-xl text-sm font-medium transition flex items-center space-x-2">
                                <span>üéµ</span>
                                <span>Music: On</span>
                            </button>
                            
                            <button id="sound-toggle" 
                                    class="px-4 py-2 bg-yellow-600/30 rounded-xl text-sm font-medium transition flex items-center space-x-2">
                                <span>üîä</span>
                                <span>Sounds: On</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Online Players Info -->
                    <div id="online-game-info" class="mt-6 pt-6 border-t border-gray-800 hidden">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-gray-900/30 rounded-xl">
                                <div class="text-sm text-gray-400">Your Majesty</div>
                                <div id="player-you" class="font-semibold royal-title"></div>
                            </div>
                            <div class="text-center p-3 bg-gray-900/30 rounded-xl">
                                <div class="text-sm text-gray-400">Opponent</div>
                                <div id="player-opponent" class="font-semibold silver-gradient"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold royal-title">Royal Profile</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-yellow-300 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-yellow-600 to-yellow-300 rounded-full mx-auto flex items-center justify-center text-2xl font-bold mb-3">
                        <span id="profile-avatar">üëë</span>
                    </div>
                    <h4 id="profile-name" class="text-xl font-bold text-white"></h4>
                    <p id="profile-username" class="silver-gradient"></p>
                </div>
                
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-gray-900/30 rounded-xl">
                        <div class="royal-title text-2xl font-bold" id="profile-wins">0</div>
                        <div class="text-xs text-gray-400">Victories</div>
                    </div>
                    <div class="p-3 bg-gray-900/30 rounded-xl">
                        <div class="silver-gradient text-2xl font-bold" id="profile-losses">0</div>
                        <div class="text-xs text-gray-400">Defeats</div>
                    </div>
                    <div class="p-3 bg-gray-900/30 rounded-xl">
                        <div class="silver-gradient text-2xl font-bold" id="profile-draws">0</div>
                        <div class="text-xs text-gray-400">Stalemates</div>
                    </div>
                </div>
                
                <!-- Contact Button Added -->
                <div class="pt-4 border-t border-gray-800">
                    <button onclick="window.open('https://vcarrd.com/shakil-mr-mirror/profile', '_blank')" 
                            class="btn-noble w-full py-3 rounded-xl font-semibold mb-4">
                        üìû Contact
                    </button>
                    
                    <button onclick="closeProfileModal()" 
                            class="btn-royal w-full py-3 rounded-xl font-semibold">
                        Close Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            increment,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMHVz6dXs7vuq10OcoYSx0X1xcYXiIWAc",
            authDomain: "mirror-toe.firebaseapp.com",
            projectId: "mirror-toe",
            storageBucket: "mirror-toe.firebasestorage.app",
            messagingSenderId: "845039024700",
            appId: "1:845039024700:web:fa301a97e56d71bff6a139"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM Elements
        const welcomeView = document.getElementById('welcome-view');
        const gameView = document.getElementById('game-view');
        const gameBoardContainer = document.getElementById('game-board-container');
        const modeSelection = document.getElementById('mode-selection');
        const onlineControls = document.getElementById('online-controls');
        const boardGrid = document.getElementById('board-grid');
        const accountForm = document.getElementById('account-form');
        const loginForm = document.getElementById('login-form');
        const welcomeContent = document.getElementById('welcome-content');
        const profileModal = document.getElementById('profile-modal');
        
        // Audio Elements
        const bgMusic = document.getElementById('bg-music');
        const tapSound = document.getElementById('tap-sound');
        const winSound = document.getElementById('win-sound');
        const drawSound = document.getElementById('draw-sound');
        
        // Game State
        let gameState = {
            board: Array(9).fill(''),
            currentPlayer: 'X',
            gameActive: false,
            gameMode: null,
            gameId: null,
            mySymbol: 'X',
            isPlayerTurn: false,
            scores: { X: 0, O: 0, draws: 0 },
            audioEnabled: true,
            soundsEnabled: true,
            currentUser: null,
            userProfile: null,
            unsubscribeGame: null,
            isGuest: true,
            playerStats: { wins: 0, losses: 0, draws: 0 },
            onlineGameEnded: false,
            waitTimer: null,
            gameCreationTime: null
        };
        
        // Initialize Game
        function initGame() {
            // Setup event listeners
            setupEventListeners();
            
            // Initialize audio (autoplay with user interaction)
            initializeAudio();
            
            // Check authentication state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in anonymously
                    gameState.currentUser = user;
                    
                    // Check if user has a profile
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (userDoc.exists()) {
                            gameState.userProfile = userDoc.data();
                            gameState.isGuest = gameState.userProfile.isGuest || false;
                            gameState.playerStats = {
                                wins: gameState.userProfile.wins || 0,
                                losses: gameState.userProfile.losses || 0,
                                draws: gameState.userProfile.draws || 0
                            };
                            
                            if (!gameState.isGuest) {
                                document.getElementById('current-username').textContent = 
                                    `@${gameState.userProfile.username}`;
                            } else {
                                document.getElementById('current-username').textContent = 
                                    `Guest_${user.uid.slice(0, 6)}`;
                            }
                            
                            showGameView();
                        } else {
                            // New user - show welcome screen
                            showWelcomeView();
                        }
                    } catch (error) {
                        console.log("Error loading user profile:", error);
                        showWelcomeView();
                    }
                } else {
                    // No user - show welcome screen
                    showWelcomeView();
                }
            });
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Welcome screen buttons
            document.getElementById('quick-play-btn').addEventListener('click', quickPlay);
            document.getElementById('royal-login-btn').addEventListener('click', showLoginForm);
            document.getElementById('create-account-text').addEventListener('click', showAccountForm);
            document.getElementById('back-to-welcome').addEventListener('click', showWelcomeContent);
            document.getElementById('back-to-welcome-from-login').addEventListener('click', showWelcomeContent);
            document.getElementById('register-btn').addEventListener('click', registerAccount);
            document.getElementById('login-btn').addEventListener('click', loginAccount);
            
            // Game controls
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('profile-btn').addEventListener('click', showProfileModal);
            document.getElementById('restart-game').addEventListener('click', restartGame);
            document.getElementById('change-mode').addEventListener('click', backToModes);
            document.getElementById('audio-toggle').addEventListener('click', toggleAudio);
            document.getElementById('sound-toggle').addEventListener('click', toggleSounds);
            
            // Auto-play audio on first user interaction
            document.addEventListener('click', () => {
                if (gameState.audioEnabled && bgMusic.paused) {
                    bgMusic.play().catch(e => console.log("Autoplay prevented"));
                }
            }, { once: true });
        }
        
        // Initialize Audio
        function initializeAudio() {
            // Set volumes
            bgMusic.volume = 0.3;
            tapSound.volume = 0.5;
            winSound.volume = 0.6;
            drawSound.volume = 0.6;
            
            // Set audio to be on by default
            gameState.audioEnabled = true;
            gameState.soundsEnabled = true;
            
            // Update button states
            document.getElementById('audio-toggle').innerHTML = '<span>üéµ</span><span>Music: On</span>';
            document.getElementById('sound-toggle').innerHTML = '<span>üîä</span><span>Sounds: On</span>';
            
            // Try to play background music with user interaction
            document.addEventListener('click', () => {
                bgMusic.play().then(() => {
                    console.log("Music started");
                }).catch(e => {
                    console.log("Autoplay blocked. User interaction required.");
                });
            }, { once: true });
        }
        
        // User Management
        async function quickPlay() {
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                // Create guest profile
                await setDoc(doc(db, 'users', user.uid), {
                    displayName: 'Royal Guest',
                    username: `guest_${user.uid.slice(0, 8)}`,
                    isGuest: true,
                    createdAt: serverTimestamp(),
                    lastSeen: serverTimestamp(),
                    wins: 0,
                    losses: 0,
                    draws: 0
                });
                
                gameState.userProfile = {
                    displayName: 'Royal Guest',
                    username: `guest_${user.uid.slice(0, 8)}`,
                    isGuest: true,
                    wins: 0,
                    losses: 0,
                    draws: 0
                };
                
                gameState.isGuest = true;
                gameState.playerStats = { wins: 0, losses: 0, draws: 0 };
                
                document.getElementById('current-username').textContent = 
                    `Guest_${user.uid.slice(0, 6)}`;
                
                showGameView();
                
            } catch (error) {
                console.error('Quick play error:', error);
                showMessage('Could not start quick play. Please try again.', 'error');
            }
        }
        
        function showAccountForm() {
            welcomeContent.classList.add('hidden');
            accountForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        }
        
        function showLoginForm() {
            welcomeContent.classList.add('hidden');
            loginForm.classList.remove('hidden');
            accountForm.classList.add('hidden');
        }
        
        function showWelcomeContent() {
            accountForm.classList.add('hidden');
            loginForm.classList.add('hidden');
            welcomeContent.classList.remove('hidden');
        }
        
        async function registerAccount() {
            const displayName = document.getElementById('display-name').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const passcode = document.getElementById('passcode').value;
            const confirmPasscode = document.getElementById('confirm-passcode').value;
            const errorDiv = document.getElementById('auth-error');
            const authSpinner = document.getElementById('auth-spinner');
            
            errorDiv.classList.add('hidden');
            authSpinner.classList.remove('hidden');
            
            // Validation
            if (!displayName || !username || !passcode || !confirmPasscode) {
                showError('Please fill in all fields');
                authSpinner.classList.add('hidden');
                return;
            }
            
            if (passcode !== confirmPasscode) {
                showError('Passcodes do not match');
                authSpinner.classList.add('hidden');
                return;
            }
            
            if (username.length < 3) {
                showError('Username must be at least 3 characters');
                authSpinner.classList.add('hidden');
                return;
            }
            
            if (passcode.length < 4) {
                showError('Passcode must be at least 4 characters');
                authSpinner.classList.add('hidden');
                return;
            }
            
            // Check if username is already taken
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showError('Username already taken');
                    authSpinner.classList.add('hidden');
                    return;
                }
                
                // Sign in anonymously first
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                // Create user profile with passcode
                await setDoc(doc(db, 'users', user.uid), {
                    displayName: displayName,
                    username: username,
                    passcode: passcode,
                    isGuest: false,
                    createdAt: serverTimestamp(),
                    lastSeen: serverTimestamp(),
                    wins: 0,
                    losses: 0,
                    draws: 0
                });
                
                gameState.userProfile = {
                    displayName: displayName,
                    username: username,
                    isGuest: false,
                    wins: 0,
                    losses: 0,
                    draws: 0
                };
                
                gameState.isGuest = false;
                gameState.playerStats = { wins: 0, losses: 0, draws: 0 };
                
                document.getElementById('current-username').textContent = `@${username}`;
                authSpinner.classList.add('hidden');
                
                showGameView();
                
            } catch (error) {
                console.error('Registration error:', error);
                showError('Registration failed: ' + error.message);
                authSpinner.classList.add('hidden');
            }
        }
        
        async function loginAccount() {
            const username = document.getElementById('login-username').value.trim().toLowerCase();
            const passcode = document.getElementById('login-passcode').value;
            const errorDiv = document.getElementById('login-error');
            const loginSpinner = document.getElementById('login-spinner');
            
            errorDiv.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            
            // Validation
            if (!username || !passcode) {
                showLoginError('Please fill in all fields');
                loginSpinner.classList.add('hidden');
                return;
            }
            
            try {
                // Find user by username
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showLoginError('Username not found');
                    loginSpinner.classList.add('hidden');
                    return;
                }
                
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                
                // Check passcode
                if (userData.passcode !== passcode) {
                    showLoginError('Incorrect passcode');
                    loginSpinner.classList.add('hidden');
                    return;
                }
                
                // Sign in anonymously and link to existing account
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                // Update last seen
                await updateDoc(doc(db, 'users', userDoc.id), {
                    lastSeen: serverTimestamp()
                });
                
                gameState.userProfile = userData;
                gameState.isGuest = false;
                gameState.playerStats = {
                    wins: userData.wins || 0,
                    losses: userData.losses || 0,
                    draws: userData.draws || 0
                };
                
                document.getElementById('current-username').textContent = `@${username}`;
                loginSpinner.classList.add('hidden');
                
                showGameView();
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Login failed: ' + error.message);
                loginSpinner.classList.add('hidden');
            }
        }
        
        async function logout() {
            try {
                if (gameState.unsubscribeGame) {
                    gameState.unsubscribeGame();
                    gameState.unsubscribeGame = null;
                }
                
                // Clear any wait timer
                if (gameState.waitTimer) {
                    clearTimeout(gameState.waitTimer);
                    gameState.waitTimer = null;
                }
                
                // If online game, clean up
                if (gameState.gameMode === 'online' && gameState.gameId) {
                    await deleteDoc(doc(db, 'games', gameState.gameId));
                }
                
                await signOut(auth);
                gameState.currentUser = null;
                gameState.userProfile = null;
                showWelcomeView();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // View Management
        function showWelcomeView() {
            welcomeView.classList.remove('hidden');
            gameView.classList.add('hidden');
            welcomeContent.classList.remove('hidden');
            accountForm.classList.add('hidden');
            loginForm.classList.add('hidden');
            profileModal.classList.add('hidden');
        }
        
        function showGameView() {
            welcomeView.classList.add('hidden');
            gameView.classList.remove('hidden');
            modeSelection.classList.remove('hidden');
            gameBoardContainer.classList.add('hidden');
            onlineControls.classList.add('hidden');
            profileModal.classList.add('hidden');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function showMessage(message, type = 'info') {
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                const colors = {
                    info: 'text-blue-400',
                    success: 'text-yellow-300',
                    error: 'text-red-400',
                    warning: 'text-yellow-400'
                };
                
                statusElement.innerHTML = `<span class="${colors[type]}">${message}</span>`;
            }
        }
        
        // Profile Modal
        function showProfileModal() {
            if (!gameState.userProfile) return;
            
            document.getElementById('profile-name').textContent = gameState.userProfile.displayName;
            document.getElementById('profile-username').textContent = `@${gameState.userProfile.username}`;
            
            // Show correct stats (already calculated in playerStats)
            document.getElementById('profile-wins').textContent = gameState.playerStats.wins;
            document.getElementById('profile-losses').textContent = gameState.playerStats.losses;
            document.getElementById('profile-draws').textContent = gameState.playerStats.draws;
            
            profileModal.classList.remove('hidden');
        }
        
        function closeProfileModal() {
            profileModal.classList.add('hidden');
        }
        
        // Game Mode Management
        function setGameMode(mode) {
            gameState.gameMode = mode;
            gameState.gameId = null;
            gameState.onlineGameEnded = false;
            
            modeSelection.classList.add('hidden');
            gameBoardContainer.classList.remove('hidden');
            document.getElementById('online-game-info').classList.add('hidden');
            document.getElementById('local-controls').classList.remove('hidden');
            
            startNewGame();
        }
        
        function showOnlineMode() {
            modeSelection.classList.add('hidden');
            onlineControls.classList.remove('hidden');
            
            // Generate game ID
            const gameId = 'ROYAL-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            document.getElementById('game-id-display').textContent = gameId;
            gameState.gameId = gameId;
        }
        
        function backToModes() {
            // Clear any wait timer
            if (gameState.waitTimer) {
                clearTimeout(gameState.waitTimer);
                gameState.waitTimer = null;
            }
            
            // Unsubscribe from game updates
            if (gameState.unsubscribeGame) {
                gameState.unsubscribeGame();
                gameState.unsubscribeGame = null;
            }
            
            // Clean up online game if exists
            if (gameState.gameMode === 'online' && gameState.gameId) {
                deleteDoc(doc(db, 'games', gameState.gameId)).catch(() => {});
            }
            
            gameBoardContainer.classList.add('hidden');
            onlineControls.classList.add('hidden');
            modeSelection.classList.remove('hidden');
            gameState.gameMode = null;
            gameState.gameId = null;
            gameState.onlineGameEnded = false;
        }
        
        // Online Game Management
        async function createOnlineGame() {
            if (!gameState.currentUser) {
                showMessage('Please login first', 'error');
                return;
            }
            
            const gameId = gameState.gameId || 'ROYAL-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            
            try {
                const playerName = gameState.userProfile?.displayName || 'Anonymous';
                const playerUsername = gameState.userProfile?.username || `guest_${gameState.currentUser.uid.slice(0, 6)}`;
                
                const gameData = {
                    playerX: {
                        uid: gameState.currentUser.uid,
                        name: playerName,
                        username: playerUsername
                    },
                    playerO: null,
                    board: Array(9).fill(''),
                    currentPlayer: 'X',
                    gameActive: false, // Game is not active until opponent joins
                    status: 'waiting',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    gameEnded: false,
                    gameCreationTime: Date.now()
                };
                
                await setDoc(doc(db, 'games', gameId), gameData);
                
                gameState.gameMode = 'online';
                gameState.mySymbol = 'X';
                gameState.isPlayerTurn = false; // Not player's turn until opponent joins
                gameState.gameId = gameId;
                gameState.onlineGameEnded = false;
                gameState.gameCreationTime = Date.now();
                
                onlineControls.classList.add('hidden');
                gameBoardContainer.classList.remove('hidden');
                document.getElementById('online-game-info').classList.remove('hidden');
                document.getElementById('local-controls').classList.add('hidden');
                
                // Update player info
                document.getElementById('player-you').textContent = playerName;
                document.getElementById('player-opponent').textContent = 'Waiting for opponent...';
                
                // Clear any existing timer
                if (gameState.waitTimer) {
                    clearTimeout(gameState.waitTimer);
                }
                
                // Set 3-minute wait timer
                gameState.waitTimer = setTimeout(async () => {
                    if (gameState.gameMode === 'online' && gameState.gameId === gameId) {
                        const gameRef = doc(db, 'games', gameId);
                        const gameSnap = await getDoc(gameRef);
                        if (gameSnap.exists()) {
                            const gameData = gameSnap.data();
                            if (!gameData.playerO) {
                                // No opponent joined in 3 minutes
                                showMessage('No opponent joined in 3 minutes. Returning to mode selection.', 'error');
                                setTimeout(() => {
                                    backToModes();
                                }, 3000);
                            }
                        }
                    }
                }, 180000); // 3 minutes = 180000 milliseconds
                
                startNewGame();
                listenToGameUpdates(gameId);
                
                showMessage(`Royal Battle created! Share Seal: <span class="font-mono">${gameId}</span><br>Waiting for opponent (3 minutes)`, 'success');
                
            } catch (error) {
                console.error('Error creating game:', error);
                showMessage('Failed to create battle: ' + error.message, 'error');
            }
        }
        
        async function joinOnlineGame() {
            const gameId = document.getElementById('join-game-input').value.trim().toUpperCase();
            
            if (!gameId) {
                showMessage('Please enter a Royal Seal', 'error');
                return;
            }
            
            if (!gameState.currentUser) {
                showMessage('Please login first', 'error');
                return;
            }
            
            try {
                const gameDoc = await getDoc(doc(db, 'games', gameId));
                
                if (!gameDoc.exists()) {
                    showMessage('Battle not found', 'error');
                    return;
                }
                
                const gameData = gameDoc.data();
                
                // Check if game is older than 3 minutes
                const gameAge = Date.now() - (gameData.gameCreationTime || Date.now());
                if (gameAge > 180000 && !gameData.playerO) {
                    showMessage('This battle has expired (3 minutes)', 'error');
                    await deleteDoc(doc(db, 'games', gameId));
                    return;
                }
                
                // Check if game is already full
                if (gameData.playerO) {
                    showMessage('Battle is full', 'error');
                    return;
                }
                
                // Check if user is already in the game
                if (gameData.playerX.uid === gameState.currentUser.uid) {
                    showMessage('You are already in this battle as Player X', 'info');
                    // Rejoin as player X
                    gameState.gameMode = 'online';
                    gameState.mySymbol = 'X';
                    gameState.isPlayerTurn = gameData.currentPlayer === 'X';
                    gameState.gameId = gameId;
                    gameState.onlineGameEnded = false;
                    
                    onlineControls.classList.add('hidden');
                    gameBoardContainer.classList.remove('hidden');
                    document.getElementById('online-game-info').classList.remove('hidden');
                    document.getElementById('local-controls').classList.add('hidden');
                    
                    document.getElementById('player-you').textContent = gameData.playerX.name;
                    document.getElementById('player-opponent').textContent = gameData.playerO?.name || 'Waiting...';
                    
                    startNewGame();
                    listenToGameUpdates(gameId);
                    return;
                }
                
                // Join as player O
                const playerName = gameState.userProfile?.displayName || 'Anonymous';
                const playerUsername = gameState.userProfile?.username || `guest_${gameState.currentUser.uid.slice(0, 6)}`;
                
                await updateDoc(doc(db, 'games', gameId), {
                    playerO: {
                        uid: gameState.currentUser.uid,
                        name: playerName,
                        username: playerUsername
                    },
                    status: 'active',
                    gameActive: true,
                    updatedAt: serverTimestamp()
                });
                
                gameState.gameMode = 'online';
                gameState.mySymbol = 'O';
                gameState.isPlayerTurn = gameData.currentPlayer === 'O';
                gameState.gameId = gameId;
                gameState.onlineGameEnded = false;
                
                // Clear the wait timer since opponent joined
                if (gameState.waitTimer) {
                    clearTimeout(gameState.waitTimer);
                    gameState.waitTimer = null;
                }
                
                onlineControls.classList.add('hidden');
                gameBoardContainer.classList.remove('hidden');
                document.getElementById('online-game-info').classList.remove('hidden');
                document.getElementById('local-controls').classList.add('hidden');
                
                document.getElementById('player-you').textContent = playerName;
                document.getElementById('player-opponent').textContent = gameData.playerX.name;
                
                startNewGame();
                listenToGameUpdates(gameId);
                
                showMessage(`Joined battle against ${gameData.playerX.name}!`, 'success');
                
            } catch (error) {
                console.error('Error joining game:', error);
                showMessage('Failed to join battle: ' + error.message, 'error');
            }
        }
        
        function listenToGameUpdates(gameId) {
            const gameRef = doc(db, 'games', gameId);
            
            // Unsubscribe from previous listener
            if (gameState.unsubscribeGame) {
                gameState.unsubscribeGame();
            }
            
            gameState.unsubscribeGame = onSnapshot(gameRef, async (snapshot) => {
                if (!snapshot.exists()) {
                    // Game was deleted (player left)
                    showMessage('Battle abandoned by opponent', 'error');
                    setTimeout(() => {
                        backToModes();
                    }, 3000);
                    return;
                }
                
                const gameData = snapshot.data();
                
                // Check if opponent left after game started
                if (gameState.gameActive) {
                    if (gameState.mySymbol === 'X' && !gameData.playerO) {
                        showMessage('Opponent left the battle', 'error');
                        setTimeout(() => {
                            backToModes();
                        }, 3000);
                        return;
                    }
                    
                    if (gameState.mySymbol === 'O' && !gameData.playerX) {
                        showMessage('Opponent left the battle', 'error');
                        setTimeout(() => {
                            backToModes();
                        }, 3000);
                        return;
                    }
                }
                
                // Update opponent info
                if (gameData.playerO && gameData.playerX.uid === gameState.currentUser.uid) {
                    document.getElementById('player-opponent').textContent = gameData.playerO.name;
                } else if (gameData.playerX.uid !== gameState.currentUser.uid) {
                    document.getElementById('player-opponent').textContent = gameData.playerX.name;
                }
                
                // If opponent joined, activate the game
                if (gameData.playerO && !gameState.gameActive) {
                    gameState.gameActive = true;
                    gameState.isPlayerTurn = (gameState.mySymbol === gameData.currentPlayer);
                }
                
                gameState.board = gameData.board || Array(9).fill('');
                gameState.currentPlayer = gameData.currentPlayer || 'X';
                gameState.gameActive = gameData.gameActive !== false;
                
                // Update turn indicator
                gameState.isPlayerTurn = (gameState.currentPlayer === gameState.mySymbol);
                
                updateBoard();
                updateStatus();
                
                // Check for win
                const result = checkGameResult();
                if ((result.winner || result.draw) && !gameState.onlineGameEnded) {
                    gameState.gameActive = false;
                    gameState.onlineGameEnded = true;
                    
                    const winType = result.winner === gameState.mySymbol ? 'win' : 
                                   result.draw ? 'draw' : 'loss';
                    
                    handleGameEnd(result.winner, result.winningCells, result.draw, winType);
                    
                    // Auto-start new game after delay for online mode
                    setTimeout(async () => {
                        if (gameState.gameMode === 'online' && gameState.gameId) {
                            // Reset game data for new round
                            await updateDoc(doc(db, 'games', gameState.gameId), {
                                board: Array(9).fill(''),
                                currentPlayer: 'X',
                                gameActive: true,
                                gameEnded: false,
                                updatedAt: serverTimestamp()
                            });
                            
                            gameState.gameActive = true;
                            gameState.onlineGameEnded = false;
                            gameState.currentPlayer = 'X';
                            gameState.isPlayerTurn = (gameState.mySymbol === 'X');
                            gameState.board = Array(9).fill('');
                            
                            updateBoard();
                            updateStatus();
                            showMessage("New round begins! Good luck!", 'success');
                        }
                    }, 3000);
                }
            }, (error) => {
                console.error('Game update error:', error);
                showMessage('Connection error. Try rejoining.', 'error');
            });
        }
        
        // Game Logic
        function startNewGame() {
            gameState.board = Array(9).fill('');
            gameState.currentPlayer = 'X';
            gameState.gameActive = gameState.gameMode !== 'online'; // Online games are not active until opponent joins
            
            updateBoard();
            updateStatus();
        }
        
        function updateBoard() {
            boardGrid.innerHTML = '';
            
            gameState.board.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = `game-cell rounded-xl flex items-center justify-center cursor-pointer transition-all duration-300 ${cell ? 'occupied' : ''}`;
                
                if (cell) {
                    cellElement.classList.add(cell === 'X' ? 'x-mark' : 'o-mark');
                    cellElement.innerHTML = `<span class="cell-content text-5xl">${cell}</span>`;
                }
                
                if (gameState.gameActive && !cell) {
                    cellElement.addEventListener('click', () => makeMove(index));
                }
                
                boardGrid.appendChild(cellElement);
            });
        }
        
        function makeMove(index) {
            if (!gameState.gameActive || gameState.board[index]) return;
            
            if (gameState.gameMode === 'online' && !gameState.isPlayerTurn) {
                showMessage("Wait for your turn!", 'warning');
                return;
            }
            
            // Play tap sound
            if (gameState.soundsEnabled) {
                tapSound.currentTime = 0;
                tapSound.play().catch(e => console.log("Sound play failed"));
            }
            
            // Make move locally
            gameState.board[index] = gameState.currentPlayer;
            
            // Check for win
            const result = checkGameResult();
            
            if (gameState.gameMode === 'online') {
                updateOnlineGame(result);
            } else {
                let winType = 'info';
                if (result.winner) {
                    // For AI mode: X is player, O is AI
                    if (gameState.gameMode === 'ai') {
                        winType = result.winner === 'X' ? 'win' : 'loss';
                    } else {
                        // For local mode: just show winner
                        winType = 'info';
                    }
                } else if (result.draw) {
                    winType = 'draw';
                }
                
                if (result.winner || result.draw) {
                    gameState.gameActive = false;
                    handleGameEnd(result.winner, result.winningCells, result.draw, winType);
                } else {
                    gameState.currentPlayer = gameState.currentPlayer === 'X' ? 'O' : 'X';
                    
                    if (gameState.gameMode === 'ai' && gameState.currentPlayer === 'O') {
                        setTimeout(makeAIMove, 500);
                    }
                }
                
                updateBoard();
                updateStatus();
            }
        }
        
        async function updateOnlineGame(result) {
            if (!gameState.gameId || !gameState.currentUser) return;
            
            const gameActive = !(result.winner || result.draw);
            const nextPlayer = gameState.currentPlayer === 'X' ? 'O' : 'X';
            
            try {
                await updateDoc(doc(db, 'games', gameState.gameId), {
                    board: gameState.board,
                    currentPlayer: nextPlayer,
                    gameActive: gameActive,
                    updatedAt: serverTimestamp(),
                    ...(result.winner && { winner: result.winner, winningCells: result.winningCells }),
                    ...(result.draw && { draw: true })
                });
                
                gameState.currentPlayer = nextPlayer;
                gameState.isPlayerTurn = false;
                updateBoard();
                updateStatus();
                
            } catch (error) {
                console.error('Error updating game:', error);
                showMessage('Failed to sync move', 'error');
            }
        }
        
        function makeAIMove() {
            if (!gameState.gameActive) return;
            
            // Simple AI strategy
            const emptyCells = gameState.board
                .map((cell, index) => cell === '' ? index : -1)
                .filter(index => index !== -1);
            
            if (emptyCells.length === 0) return;
            
            let moveIndex = -1;
            
            // 1. Try to win
            for (let cell of emptyCells) {
                const testBoard = [...gameState.board];
                testBoard[cell] = 'O';
                if (checkGameResult(testBoard).winner === 'O') {
                    moveIndex = cell;
                    break;
                }
            }
            
            // 2. Try to block
            if (moveIndex === -1) {
                for (let cell of emptyCells) {
                    const testBoard = [...gameState.board];
                    testBoard[cell] = 'X';
                    if (checkGameResult(testBoard).winner === 'X') {
                        moveIndex = cell;
                        break;
                    }
                }
            }
            
            // 3. Take center
            if (moveIndex === -1 && gameState.board[4] === '') {
                moveIndex = 4;
            }
            
            // 4. Take random corner
            if (moveIndex === -1) {
                const corners = [0, 2, 6, 8].filter(i => gameState.board[i] === '');
                if (corners.length > 0) {
                    moveIndex = corners[Math.floor(Math.random() * corners.length)];
                }
            }
            
            // 5. Take random side
            if (moveIndex === -1) {
                const sides = [1, 3, 5, 7].filter(i => gameState.board[i] === '');
                if (sides.length > 0) {
                    moveIndex = sides[Math.floor(Math.random() * sides.length)];
                }
            }
            
            // Make the move
            if (moveIndex !== -1) {
                gameState.board[moveIndex] = 'O';
                
                // Play sound for AI move
                if (gameState.soundsEnabled) {
                    setTimeout(() => {
                        tapSound.currentTime = 0;
                        tapSound.play().catch(e => console.log("Sound play failed"));
                    }, 300);
                }
                
                const result = checkGameResult();
                const winType = result.winner ? (result.winner === 'X' ? 'win' : 'loss') : 
                              result.draw ? 'draw' : 'info';
                
                if (result.winner || result.draw) {
                    gameState.gameActive = false;
                    handleGameEnd(result.winner, result.winningCells, result.draw, winType);
                } else {
                    gameState.currentPlayer = 'X';
                }
                
                updateBoard();
                updateStatus();
            }
        }
        
        function checkGameResult(board = gameState.board) {
            const winPatterns = [
                [0,1,2], [3,4,5], [6,7,8], // Rows
                [0,3,6], [1,4,7], [2,5,8], // Columns
                [0,4,8], [2,4,6]           // Diagonals
            ];
            
            for (let pattern of winPatterns) {
                const [a,b,c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return {
                        winner: board[a],
                        winningCells: pattern,
                        draw: false
                    };
                }
            }
            
            if (board.every(cell => cell !== '')) {
                return {
                    winner: null,
                    winningCells: null,
                    draw: true
                };
            }
            
            return {
                winner: null,
                winningCells: null,
                draw: false
            };
        }
        
        async function handleGameEnd(winner, winningCells, isDraw = false, winType = 'info') {
            // Highlight winning cells
            if (winningCells) {
                winningCells.forEach(index => {
                    const cells = document.querySelectorAll('.game-cell');
                    if (cells[index]) {
                        cells[index].classList.add('winning-cell');
                        cells[index].classList.add('winner-glow');
                    }
                });
            }
            
            // Play sound
            if (gameState.soundsEnabled) {
                if (winner) {
                    winSound.currentTime = 0;
                    winSound.play().catch(e => console.log("Sound play failed"));
                } else if (isDraw) {
                    drawSound.currentTime = 0;
                    drawSound.play().catch(e => console.log("Sound play failed"));
                }
            }
            
            // Update scores
            if (winner) {
                gameState.scores[winner]++;
                
                // Show appropriate message for local/AI modes
                if (gameState.gameMode === 'local') {
                    showMessage(`${winner} wins the royal duel! üëë`, 'success');
                } else if (gameState.gameMode === 'ai') {
                    if (winType === 'win') {
                        showMessage('You outsmarted Mr. Mirror! You win! üëë', 'success');
                    } else if (winType === 'loss') {
                        showMessage('Mr. Mirror triumphs! You lose! ü§ñ', 'error');
                    } else {
                        showMessage(`${winner} claims victory! üëë`, 'success');
                    }
                } else {
                    showMessage(`${winner} claims victory! üëë`, 'success');
                }
                
                // Update stats for registered users
                if (gameState.currentUser) {
                    await updateUserStats(winType);
                }
            } else if (isDraw) {
                gameState.scores.draws++;
                
                if (gameState.gameMode === 'local') {
                    showMessage("A royal stalemate! ‚öîÔ∏è Draw!", 'info');
                } else if (gameState.gameMode === 'ai') {
                    showMessage("A draw with Mr. Mirror! ‚öîÔ∏è", 'info');
                } else {
                    showMessage("A royal stalemate! ‚öîÔ∏è", 'info');
                }
                
                if (gameState.currentUser) {
                    await updateUserStats('draw');
                }
            }
            
            updateScoreDisplay();
            
            // Auto-restart for local/AI games
            if (gameState.gameMode !== 'online') {
                setTimeout(() => {
                    startNewGame();
                }, 3000);
            }
        }
        
        async function updateUserStats(result) {
            if (!gameState.currentUser) return;
            
            try {
                const userRef = doc(db, 'users', gameState.currentUser.uid);
                const updateData = {
                    lastSeen: serverTimestamp()
                };
                
                if (result === 'win') {
                    updateData.wins = increment(1);
                    gameState.playerStats.wins++;
                } else if (result === 'loss') {
                    updateData.losses = increment(1);
                    gameState.playerStats.losses++;
                } else if (result === 'draw') {
                    updateData.draws = increment(1);
                    gameState.playerStats.draws++;
                }
                
                await updateDoc(userRef, updateData);
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        function updateStatus() {
            const statusElement = document.getElementById('status-message');
            const turnElement = document.getElementById('turn-indicator');
            
            if (!gameState.gameActive) {
                statusElement.textContent = "Battle Concluded";
                if (turnElement) {
                    turnElement.innerHTML = '<span class="status-dot offline mr-2"></span><span>Royal battle finished</span>';
                }
                return;
            }
            
            if (gameState.gameMode === 'online') {
                if (!gameState.gameActive) {
                    statusElement.innerHTML = '<span class="text-yellow-300">Waiting for opponent to join...</span>';
                    if (turnElement) {
                        turnElement.innerHTML = '<span class="status-dot waiting mr-2"></span><span>Opponent has 3 minutes to join</span>';
                    }
                } else {
                    const playerText = gameState.mySymbol === 'X' ? ' (Your Majesty)' : ' (Your Grace)';
                    const opponentText = gameState.isPlayerTurn ? 'Your turn to strike' : 'Opponent\'s turn';
                    const dotClass = gameState.isPlayerTurn ? 'online' : 'waiting';
                    
                    statusElement.innerHTML = `<span class="${gameState.currentPlayer === 'X' ? 'royal-title' : 'silver-gradient'}">${gameState.currentPlayer}${playerText}</span>`;
                    if (turnElement) {
                        turnElement.innerHTML = `<span class="status-dot ${dotClass} mr-2"></span><span>${opponentText}</span>`;
                    }
                }
                
            } else if (gameState.gameMode === 'ai') {
                const playerText = gameState.currentPlayer === 'X' ? 'Your strategic move' : 'Mr. Mirror contemplates...';
                const dotClass = gameState.currentPlayer === 'X' ? 'online' : 'waiting';
                
                statusElement.innerHTML = `<span class="${gameState.currentPlayer === 'X' ? 'royal-title' : 'silver-gradient'}">${gameState.currentPlayer}</span>`;
                if (turnElement) {
                    turnElement.innerHTML = `<span class="status-dot ${dotClass} mr-2"></span><span>${playerText}</span>`;
                }
                
            } else {
                statusElement.innerHTML = `<span class="${gameState.currentPlayer === 'X' ? 'royal-title' : 'silver-gradient'}">${gameState.currentPlayer}</span>'s royal move`;
                if (turnElement) {
                    turnElement.innerHTML = '<span class="status-dot online mr-2"></span><span>Royal duel in progress</span>';
                }
            }
        }
        
        function updateScoreDisplay() {
            document.getElementById('score-x').textContent = gameState.scores.X;
            document.getElementById('score-o').textContent = gameState.scores.O;
            document.getElementById('score-draws').textContent = gameState.scores.draws;
        }
        
        function restartGame() {
            startNewGame();
        }
        
        // Audio Controls
        function toggleAudio() {
            gameState.audioEnabled = !gameState.audioEnabled;
            const button = document.getElementById('audio-toggle');
            
            if (gameState.audioEnabled) {
                bgMusic.play().catch(e => console.log("Audio play failed"));
                button.innerHTML = '<span>üéµ</span><span>Music: On</span>';
                button.classList.remove('bg-gray-800/50');
                button.classList.add('bg-yellow-600/30');
            } else {
                bgMusic.pause();
                button.innerHTML = '<span>üéµ</span><span>Music: Off</span>';
                button.classList.remove('bg-yellow-600/30');
                button.classList.add('bg-gray-800/50');
            }
        }
        
        function toggleSounds() {
            gameState.soundsEnabled = !gameState.soundsEnabled;
            const button = document.getElementById('sound-toggle');
            
            if (gameState.soundsEnabled) {
                button.innerHTML = '<span>üîä</span><span>Sounds: On</span>';
                button.classList.remove('bg-gray-800/50');
                button.classList.add('bg-yellow-600/30');
            } else {
                button.innerHTML = '<span>üîä</span><span>Sounds: Off</span>';
                button.classList.remove('bg-yellow-600/30');
                button.classList.add('bg-gray-800/50');
            }
        }
        
        // Utility Functions
        function copyGameId() {
            const gameId = document.getElementById('game-id-display').textContent;
            navigator.clipboard.writeText(gameId).then(() => {
                showMessage('Royal Seal copied!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = gameId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('Royal Seal copied!', 'success');
            });
        }
        
        // Initialize the game when page loads
        document.addEventListener('DOMContentLoaded', initGame);
        
        // Make functions available globally
        window.setGameMode = setGameMode;
        window.showOnlineMode = showOnlineMode;
        window.createOnlineGame = createOnlineGame;
        window.joinOnlineGame = joinOnlineGame;
        window.backToModes = backToModes;
        window.copyGameId = copyGameId;
        window.showProfileModal = showProfileModal;
        window.closeProfileModal = closeProfileModal;
        
    </script>
</body>
</html>
